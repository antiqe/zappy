
////////////////////////////////////////
//  assets: images you have to load
////////////////////////////////////////

var assets = [
	"assets/tile.png",
	"assets/tile_selected.png",
	"assets/bg.jpg",
	"assets/sprite0.png",
	"assets/sprite1.png",
	"assets/sprite2.png",
	"assets/sprite3.png",
	"assets/sprite4.png",
	"assets/sprite5.png",
	"assets/sprite6.png",
	"assets/sprite7.png",
	"assets/sprite_selected.png",
	"assets/food.png",
	"assets/rock1.png",
	"assets/rock2.png",
	"assets/rock3.png",
	"assets/rock4.png",
	"assets/rock5.png",
	"assets/rock6.png",
	"assets/icon_food.png",
	"assets/icon_rock1.png",
	"assets/icon_rock2.png",
	"assets/icon_rock3.png",
	"assets/icon_rock4.png",
	"assets/icon_rock5.png",
	"assets/icon_rock6.png",
	"assets/color.png",
	"assets/incante1.png",
	"assets/incante2.png",
	"assets/incante3.png",
	"assets/incante4.png",
	"assets/incante5.png",
	"assets/incante6.png",
	"assets/incante7.png",
	"assets/incante8.png",
	"assets/eggs.png",
	"assets/tile/0000000.png",
	"assets/tile/0000001.png",
	"assets/tile/0000010.png",
	"assets/tile/0000011.png",
	"assets/tile/0000100.png",
	"assets/tile/0000101.png",
	"assets/tile/0000110.png",
	"assets/tile/0000111.png",
	"assets/tile/0001000.png",
	"assets/tile/0001001.png",
	"assets/tile/0001010.png",
	"assets/tile/0001011.png",
	"assets/tile/0001100.png",
	"assets/tile/0001101.png",
	"assets/tile/0001110.png",
	"assets/tile/0001111.png",
	"assets/tile/0010000.png",
	"assets/tile/0010001.png",
	"assets/tile/0010010.png",
	"assets/tile/0010011.png",
	"assets/tile/0010100.png",
	"assets/tile/0010101.png",
	"assets/tile/0010110.png",
	"assets/tile/0010111.png",
	"assets/tile/0011000.png",
	"assets/tile/0011001.png",
	"assets/tile/0011010.png",
	"assets/tile/0011011.png",
	"assets/tile/0011100.png",
	"assets/tile/0011101.png",
	"assets/tile/0011110.png",
	"assets/tile/0011111.png",
	"assets/tile/0100000.png",
	"assets/tile/0100001.png",
	"assets/tile/0100010.png",
	"assets/tile/0100011.png",
	"assets/tile/0100100.png",
	"assets/tile/0100101.png",
	"assets/tile/0100110.png",
	"assets/tile/0100111.png",
	"assets/tile/0101001.png",
	"assets/tile/0101010.png",
	"assets/tile/0101011.png",
	"assets/tile/0101100.png",
	"assets/tile/0101101.png",
	"assets/tile/0101110.png",
	"assets/tile/0101111.png",
	"assets/tile/0110000.png",
	"assets/tile/0110001.png",
	"assets/tile/0110010.png",
	"assets/tile/0110011.png",
	"assets/tile/0110100.png",
	"assets/tile/0110101.png",
	"assets/tile/0110110.png",
	"assets/tile/0110111.png",
	"assets/tile/0111000.png",
	"assets/tile/0111001.png",
	"assets/tile/0111010.png",
	"assets/tile/0111011.png",
	"assets/tile/0111100.png",
	"assets/tile/0111101.png",
	"assets/tile/0111110.png",
	"assets/tile/0111111.png",
	"assets/tile/1000000.png",
	"assets/tile/1000001.png",
	"assets/tile/1000010.png",
	"assets/tile/1000011.png",
	"assets/tile/1000100.png",
	"assets/tile/1000101.png",
	"assets/tile/1000110.png",
	"assets/tile/1000111.png",
	"assets/tile/1001000.png",
	"assets/tile/1001001.png",
	"assets/tile/1001010.png",
	"assets/tile/1001011.png",
	"assets/tile/1001100.png",
	"assets/tile/1001101.png",
	"assets/tile/1001110.png",
	"assets/tile/1001111.png",
	"assets/tile/1010000.png",
	"assets/tile/1010001.png",
	"assets/tile/1010010.png",
	"assets/tile/1010011.png",
	"assets/tile/1010100.png",
	"assets/tile/1010101.png",
	"assets/tile/1010110.png",
	"assets/tile/1010111.png",
	"assets/tile/1011000.png",
	"assets/tile/1011001.png",
	"assets/tile/1011010.png",
	"assets/tile/1011011.png",
	"assets/tile/1011100.png",
	"assets/tile/1011101.png",
	"assets/tile/1011110.png",
	"assets/tile/1011111.png",
	"assets/tile/1100000.png",
	"assets/tile/1100001.png",
	"assets/tile/1100010.png",
	"assets/tile/1100011.png",
	"assets/tile/1100100.png",
	"assets/tile/1100101.png",
	"assets/tile/1100110.png",
	"assets/tile/1100111.png",
	"assets/tile/1101000.png",
	"assets/tile/1101001.png",
	"assets/tile/1101010.png",
	"assets/tile/1101011.png",
	"assets/tile/1101100.png",
	"assets/tile/1101101.png",
	"assets/tile/1101110.png",
	"assets/tile/1101111.png",
	"assets/tile/1110000.png",
	"assets/tile/1110001.png",
	"assets/tile/1110010.png",
	"assets/tile/1110011.png",
	"assets/tile/1110100.png",
	"assets/tile/1110101.png",
	"assets/tile/1110110.png",
	"assets/tile/1110111.png",
	"assets/tile/1111000.png",
	"assets/tile/1111001.png",
	"assets/tile/1111010.png",
	"assets/tile/1111011.png",
	"assets/tile/1111100.png",
	"assets/tile/1111101.png",
	"assets/tile/1111110.png",
	"assets/tile/1111111.png"
];

////////////////////////////////////////
//  GuiWindow: create a window
////////////////////////////////////////

function	GuiWindow(size, pos) {
	this.shape = new Kinetic.Rect({
		x:	pos.x,
		y:	pos.y,
		width:	size.x,
		height:	size.y,
		fill:	'black',
		cornerRadius:	10,
		opacity:	0.2,
		shadowColor: 'black',
        shadowBlur: 40,
        shadowOffset: 20,
        shadowOpacity: 1.0
	});
}

///////////////////////////////////////
// Selected: 
///////////////////////////////////////

function 	Selected(map, src) {
	this.map = map;
	var pos = convertCoordToIso({x: 0, y: 0}, {x: tileSize.x, y: tileSize.y});
	this.shape = new Kinetic.Image({
		x: pos.x,
		y: pos.y,
		image: src,
		width: tileSize.x,
		height: tileSize.y + tileSize.offset
	});
	this.pos = {x: 0, y: 0};
}

Selected.prototype.incX = function (x) {
	if (x < 0 && this.pos.x <= 0)
		return;
	if (x > 0 && this.pos.x >= this.map.size.x - 1)
		return;
	this.pos.x += x;
	var pos = convertCoordToIso(this.pos, tileSize);
	this.shape.setPosition(pos.x, pos.y);
	this.map.move({x: 0, y: 0});
	
	this.map.layers[5].draw();
	this.map.contentWin.setRessources(this.map.tiles[this.pos.y][this.pos.x].ressources);
};

Selected.prototype.incY = function (y) {
	if (y < 0 && this.pos.y <= 0)
		return;
	if (y > 0 && this.pos.y >= this.map.size.y - 1)
		return;
	this.pos.y += y;
	var pos = convertCoordToIso(this.pos, tileSize);
	this.shape.setPosition(pos.x, pos.y);
	this.map.layers[5].draw();
	this.map.contentWin.setRessources(this.map.tiles[this.pos.y][this.pos.x].ressources);
};

////////////////////////////////////////
//  Tile: 
////////////////////////////////////////

function	Tile(stage, src, pos, size) {
	this.shape = new Kinetic.Image({
		x: pos.x,
		y: pos.y,
		image: src,
		width: size.x,
		height: size.y + size.offset,
	});
}

Tile.prototype.setRessources = function (imgs, ressources) {
	var n = [];
	for (var i = 0; i < ressources.length; i++)
		n[i] = (ressources[i] > 0 ? 1 : 0);
	var file = "assets/tile/" + n.join("") + ".png";
	this.ressources = ressources;
	this.shape.setImage(imgs[file]);
};

////////////////////////////////////////
//  Map: class inherit from Kinetic.Layer
////////////////////////////////////////

function	Map(contentWin, stage, api, assets, size) {
	this.contentWin = contentWin;
	this.size = size;
	this.stage = stage;
	this.api = api;
	this.assets = assets;
	this.layers = [];
	this.groups = [];
	this.follow = undefined;
	this.nbrTeam = 0;
	this.initTiles(stage);
	this.initSelected();
	this.initIncantations();
	this.initEggs();
	this.initPlayers();
	this.initMessages();
}

Map.prototype.loadTeam = function (team) {
	console.log("assets/sprite" + this.nbrTeam + ".png");
	this.assets[team] = this.assets["assets/sprite" + (this.nbrTeam % 8) + ".png"];
	this.nbrTeam++;
}

Map.prototype.applyShowablility = function (shape, pos, offset, size) {
	var p = {
		x:	pos.x + offset.x,
		y:	pos.y + offset.y	
	};
	if (p.x + size.x < 0 || p.y + size.y < 0 || p.x > window.innerWidth || p.y > window.innerHeight)
		shape.hide();
	else
		shape.show();
};

Map.prototype.addEggs = function (pos, id) {
	var eg = this.eggs.addEggs(pos, id);
	this.groups[3].add(eg);
	this.move({x:0, y:0});
};

Map.prototype.eclosion = function (team, id, pos, dir){
	this.eggs.eclosion(team, id, pos, dir);
};

Map.prototype.addIncante = function (pos, stat) {
	for (var i = 0; i < this.incante.tell.length; i++) {
		if (this.incante.tell[i].pos = pos) {
			if (stat == 1) {
				var el = this.incante.addIncante(pos, this.incante.tell[i].lvl);	
				this.groups[1].add(el);
				el.start();
				this.move({x:0, y:0});
			}
			this.incante.tell.splice(i, 1);
			break;
		}
	}
};

Map.prototype.addIncanteTell = function (pos, lvl) {
	this.incante.tell.push({'pos': pos, 'lvl': lvl});
}

Map.prototype.addPlayer = function (team, id, pos, direction) {
	var pl = this.players.addPlayer(team, id, pos, direction);
	this.groups[2].add(pl);
	pl.start();
};

Map.prototype.addMessage = function (pos, msg, speed) {
	var m = this.messages.addMessage(pos, "lol", msg, speed, msg);
	this.groups[4].add(m);
}

Map.prototype.addTeam = function (name) {
	this.loadTeam(name);
	this.players.addTeam(name);
};

Map.prototype.movePlayer = function (id, x, y, pos) {
	var where = {'x': x, 'y': y};
	this.players.move(id, where, pos);
};

Map.prototype.initTiles = function (stage) {
	this.groups[0] = new Kinetic.Group();
	this.layers[0] = new Kinetic.Layer();
	this.tiles = [];
	for (var j = 0; j < this.size.y; j++) {
		this.tiles[j] = [];
		for (var i = 0; i < this.size.x; i++) {
			var rl_pos = convertCoordToIso({x: i, y: j}, {x: tileSize.x, y: tileSize.y});
			this.tiles[j][i] = new Tile(stage, this.assets['assets/tile/0000000.png'], rl_pos, tileSize);
			this.groups[0].add(this.tiles[j][i].shape);
			this.applyShowablility(this.tiles[j][i].shape, rl_pos, map_offset, tileSize);
			loader.incress(percent.tiles / (this.size.x * this.size.y + 0.0));
		}
	}
	loader.addStep("Tiles loaded");
	this.layers[0].add(this.groups[0]);
};

Map.prototype.initIncantations = function () {
	this.groups[1] = new Kinetic.Group();
	this.layers[1] = new Kinetic.Layer();
	this.incante = new IncanteHandler(this, this.assets);
	this.layers[1].add(this.groups[1]);
};

Map.prototype.initPlayers = function () {
	this.groups[2] = new Kinetic.Group();
	this.layers[2] = new Kinetic.Layer();
	this.players = new PlayerHandler(this.assets, 100);
	this.layers[2].add(this.groups[2]);
};

Map.prototype.initEggs = function () {
	this.groups[3] = new Kinetic.Group();
	this.layers[3] = new Kinetic.Layer();
	this.eggs = new EggsHandler(this, this.assets["assets/eggs.png"]);
	this.layers[3].add(this.groups[3]);
};
Map.prototype.initMessages = function () {
	this.groups[4] = new Kinetic.Group();
	this.layers[4] = new Kinetic.Layer();
	this.messages = new MessageBoxHandler(this);
	this.layers[4].add(this.groups[4]);
}

Map.prototype.initSelected = function () {
	this.groups[5] = new Kinetic.Group();
	this.layers[5] = new Kinetic.Layer();
	this.selected = new Selected(this, this.assets["assets/tile_selected.png"]);
	this.groups[5].add(this.selected.shape);
	this.layers[5].add(this.groups[5]);
}


Map.prototype.idToRessourceName = function (id) {
	var res = [];
	res[0] = "Food";
	res[1] = "Linemate";
	res[2] = "Deraumere";	
	res[3] = "Sibur";
	res[4] = "Mendiane";
	res[5] = "Phiras";
	res[6] = "Thystame";
	return (res[id]);
}

Map.prototype.broadcast = function (id, msg) {
	var pos = this.players.getPos(id);
	this.addMessage(pos, "BlaBlaBl...", 400);
};

Map.prototype.drop = function (id, type) {
	var pos = this.players.getPos(id);
	var str_type = this.idToRessourceName(type);
	this.addMessage(pos, "Jete:    <" + str_type + ">", 500);
};

Map.prototype.take = function (id, type) {
	var pos = this.players.getPos(id);
	var str_type = this.idToRessourceName(type);
	this.addMessage(pos, "Ramasse:    <" + str_type + ">", 500);
};

Map.prototype.expulse = function (id) {
	var pos = this.players.getPos(id);
	this.addMessage(pos, "Casse toi c'est ma case!!!", 800);
};

Map.prototype.setSize = function (size) {
	this.size = size;
};

Map.prototype.removePlayer = function (id) {
	for (var i = 0; i < this.players.players.length; i++) {
		if (this.players.players[i].id == id) {
			this.players.players.splice(i, 1);
			this.move({x: 0, y: 0});
			break;
		}
	}
}

Map.prototype.setTile = function (x, y, content) {
	var tab = [content.food, content.linemate, content.deraumere, content.sibur, content.mendiane, content.phiras, content.thystame];
	this.tiles[y][x].setRessources(this.assets, tab);
};

Map.prototype.move = function (pos) {
	map_offset.x += pos.x;
	map_offset.y += pos.y;
	//optimisation 2
	
	for (var j = 0; j < this.size.y ; j++) {
		for (var i = 0; i < this.size.x; i++) {
			this.applyShowablility(this.tiles[j][i].shape, this.tiles[j][i].shape.getPosition(), map_offset, tileSize);
		}
	}
	for (var i = 0; i < this.groups.length; i++) {
		this.groups[i].move(pos);
		this.layers[i].draw();
	}
};

Map.prototype.moveAbsolute = function (pos) {
	map_offset.x = pos.x;
	map_offset.y = pos.y;
	//optimisation 2
	
	for (var j = 0; j < this.size.y ; j++) {
		for (var i = 0; i < this.size.x; i++) {
			this.applyShowablility(this.tiles[j][i].shape, this.tiles[j][i].shape.getPosition(), map_offset, tileSize);
		}
	}
	for (var i = 0; i < this.groups.length; i++) {
		this.groups[i].setPosition(pos.x, pos.y);
		this.layers[i].draw();
	}
};


Map.prototype.scale = function (q) {
	for (var i = 0; i < this.groups.length; i++)	{
		this.groups[i].setScale(q);
		this.layers[i].draw();
	}
}

Map.prototype.addToScene = function (scene) {
	for (var i = 0; i < this.layers.length; i++) {
		scene.add(this.layers[i]);
	}
};

////////////////////////////////////////
//  SetBackground: from an Image
////////////////////////////////////////

function	setBackground(asset) {
	var bgLayer = new Kinetic.Layer();
	var bg = new Kinetic.Image({
		x: 0,
		y: 0,
		image: asset,
		width: window.innerWidth,
		height: window.innerHeight
	});
	bgLayer.add(bg);
	return (bgLayer);
}

////////////////////////////////////////
//  InitScene: create the stage and layers
////////////////////////////////////////

function	initScene(api, images, map_size) {
	var stage = new Kinetic.Stage(
	{
		container:	'container',
		width:		window.innerWidth,
		height:		window.innerHeight,
	});
	var contentWin = new ContentWindow(images, {x: window.innerWidth - 200, y: 100});
	var map = new Map(contentWin, stage, api, images, map_size);
	initEvent(map);
	var event_manager = new EventManager({'map': map}, 100);
	var winLayer = new Kinetic.Layer();
	var playerWin = new PlayerWindow(map, images, {x: 50, y: 10});
	var nav_circle = new NavCircle(event_manager, {x: window.innerWidth - 200, y: window.innerHeight - 200}, 100);
	var win = new GuiWindow({x: window.innerWidth - 50, y: 100}, {x: 10, y: 10});

	
	map.move({x:600, y:200});

	setTimeout(function () {
			stage.add(setBackground(images['assets/bg.jpg']));
			map.addToScene(stage);
			stage.add(nav_circle.shape);
			stage.add(contentWin.shape);
			stage.add(playerWin.shape);
			loader.clear();
	}, 500);
	return ({'map': map});
}
/////////////////////////////////////////
// Event: init event key
/////////////////////////////////////////

function	initEvent(map) {
	window.addEventListener('keydown', function(e) {
    	if (e.keyCode == 37)  //Left Arrow Key
    		map.selected.incX(-1);
	    else if (e.keyCode == 39) //Right Arrow Key
    		map.selected.incX(1);
		else if (e.keyCode == 38) //up Arrow Key
	  		map.selected.incY(-1);
		else if (e.keyCode == 40)  //bottom Arrow Key
	  		map.selected.incY(1);
	});
}

////////////////////////////////////////
//  Assets Loader: call initScene only if all assets are loaded
////////////////////////////////////////

function	newGame(host) {
	var images = {};
	var nbrLoaded = 0;
	for (var r = 0; r < assets.length; r++) {
		images[assets[r]] = new Image();
		images[assets[r]].onload = function () {
			loader.incress(percent.assets / assets.length);
			if (++nbrLoaded >= assets.length) {
				loader.addStep("Assets loaded");
				startClient(host, images, initScene);
			}
		};
		images[assets[r]].src = assets[r];
	}
}

/* newGame("127.0.0.1:8000"); */
